var srvTH={cache:{},Init:function(e,a){var t=srvTH;t.SERVICE="thaiwater30/public/thailand",t._HOST_=e,t._IMG_PATH=a,t._MAIN_PAGE_=e+"/main",t.IntervalTime=125,t.currentRow=null,t.isNormalSituation={};var r=moment().add(-1,"hours").startOf("hour");t.DATE=JH.DateFormat(r,"DD MMMM YYYY"),t.DATE_TIME=JH.DateFormat(r)+("th"==JH.GetLang()?" น.":""),t.TIME=JH.DateFormat(r,"HH:mm")+("th"==JH.GetLang()?" น.":""),t.GEOJSON_THAILAND_STYLE={fillOpacity:1,opacity:.5,fillColor:"white",color:"black",weight:1,interactive:!1,onEachFeature:t.GEOJSON_THAILAND_onEachFeature},t.GEOJSON_RIVER_MAIN_STYLE={weight:.4,clickable:!1},t.GEOJSON_FILL_STYLE={fillOpacity:.8,opacity:0},t.GEOJSON_BORDER_STYLE={fillOpacity:0,opacity:1,dashArray:"3"},t.fillStyle=function(e){return $.extend({},t.GEOJSON_FILL_STYLE,e)},t.borderStyle=function(e){return $.extend({},t.GEOJSON_BORDER_STYLE,e)},t.initMap(),t.initControlMap(),t.initEvent()},initMap:function(){self=srvTH,map=LL.Map("map",{zoomControl:!1}),JH.Get("LL.tileLayer").setOpacity(.3),self.map=map,map.dragging.disable(),map.touchZoom.disable(),map.doubleClickZoom.disable(),map.scrollWheelZoom.disable(),map.boxZoom.disable(),map.keyboard.disable(),_geoJson=L.geoJson(LL.GetGeoJsonThailand(),self.GEOJSON_THAILAND_STYLE),_geoJson.addTo(map),_geoJson=L.geoJson(GEOJSON_RIVER_MAIN,self.GEOJSON_RIVER_MAIN_STYLE),_geoJson.addTo(map),map.fitBounds(_geoJson.getBounds())},initControlMap:function(){var e=srvTH,a=e.map,t=L.control({position:"topleft"});t.onAdd=function(){var e=L.DomUtil.create("div","logo");return e.innerHTML='<img src="'+srvTH._HOST_+srvTH._IMG_PATH+'banner-web.png?v=1464561387">',e},t.addTo(a);var r,n=L.control({position:"topright"});n.onAdd=function(){var e=L.DomUtil.create("div","info legend");return e.innerHTML='<h2>สถานการณ์น้ำ</h2><h3 style="margin-top:-20px;" class="text-center">ประเทศไทย</h3>',div_date=L.DomUtil.create("div","btn-primary-index text-center info date "),e.appendChild(div_date),e},n.addTo(a),(r=L.control({position:"bottomright"})).onAdd=function(){var a=L.DomUtil.create("div",""),t='<img src="'+srvTH._HOST_+srvTH._IMG_PATH+'home/NHC-logo-40.png?v=1464561387">';return a.innerHTML='<a href="'+e._MAIN_PAGE_+'" class="b">'+t+" คลังข้อมูลน้ำและภูมิอากาศแห่งชาติ  </a>",a},r.addTo(a),(r=L.control({position:"bottomright"})).onAdd=function(){var a=L.DomUtil.create("div","");srvTH._HOST_,srvTH._IMG_PATH;return a.innerHTML='<a href="'+e._MAIN_PAGE_+'" class="btn btn-md btn-primary-index">  รายละเอียด  <i class="fa fa-arrow-right"></i></a>',a},r.addTo(a);var o=document.getElementById("info"),l=document.createElement("div");l.className="col-md-6 ";var i=document.createElement("div");i.className="col-md-6 ",apiService.SendRequest("GET",srvTH.SERVICE,{},function(e){srvTH.handlerProvince(JH.GetJsonValue(e,"province")),srvTH.handlerDate(),srvTH.handlerRain(JH.GetJsonValue(e,"rain")),srvTH.handlerWaterLevel(JH.GetJsonValue(e,"waterlevel")),srvTH.handlerDam(JH.GetJsonValue(e,"dam")),srvTH.handlerWaterQuality(JH.GetJsonValue(e,"waterquality")),srvTH.handlerStorm(JH.GetJsonValue(e,"storm")),srvTH.handlerPreRain(JH.GetJsonValue(e,"pre_rain")),srvTH.handlerWave(JH.GetJsonValue(e,"wave")),srvTH.handlerWarning(JH.GetJsonValue(e,"warning")),l.appendChild(control_topleft_icon_rain()),l.appendChild(control_topleft_icon_waterlevel()),l.appendChild(control_topleft_icon_dam()),l.appendChild(control_topleft_icon_waterquality()),l.appendChild(control_topleft_icon_warnning()),i.appendChild(control_topleft_icon_storm()),i.appendChild(control_topleft_icon_clock()),i.appendChild(control_topleft_icon_wave()),i.appendChild(control_topleft_icon_flood()),8!=Object.keys(srvTH.isNormalSituation).length?($(o).find("div.normalsituation").remove(),o.appendChild(l),o.appendChild(i),$("#info").find(".control-box").each(function(){var e=$(this),a=e.find(".control-body"),t=a.find("div"),r=a.height();t.height()>r&&e.find(".control-arrow").addClass("hasDown")})):$(o).find("div.normalsituation").addClass("active")})},initEvent:function(){$("#info").on("mousedown",".control-arrow .fa-angle-up",function(){e=this,srvTH.cache.interval=setInterval(function(){arrowUpClick(e)},srvTH.IntervalTime),arrowUpClick(this)}).on("mouseup mouseleave",".control-arrow .fa-angle-up",function(){srvTH.cache.interval&&(clearInterval(srvTH.cache.interval),srvTH.cache.interval=null)}),$("#info").on("mousedown",".control-arrow .fa-angle-down",function(){e=this,srvTH.cache.interval=setInterval(function(){arrowDownClick(e)},srvTH.IntervalTime),arrowDownClick(this)}).on("mouseup mouseleave",".control-arrow .fa-angle-down",function(){srvTH.cache.interval&&(clearInterval(srvTH.cache.interval),srvTH.cache.interval=null)})},GEOJSON_THAILAND_onEachFeature:function(e,a){srvTH._onEachFeature("province",e,a)},_onEachFeature:function(e,a,t){var r=srvTH;void 0===r.FEATURE_PROVINCE&&(r.FEATURE_PROVINCE={}),void 0===r.FEATURE_PROVINCE[e]&&(r.FEATURE_PROVINCE[e]=[]),r.FEATURE_PROVINCE[e][a.properties.prov_code]=t,r.FEATURE_PROVINCE[e][a.properties.title]=t},handlerDate:function(){$("div.info.date").html(srvTH.DATE)},handlerProvince:function(e){if("OK"!=JH.GetJsonValue(e,"result"))return!1;for(var a=JH.GetJsonValue(e,"data"),t=0;t<a.length;t++){var r=a[t];province_cache(JH.GetJsonValue(r,"province_code"),r)}}},province_cache=function(e,a){if(0==arguments.length)return JH.GetJsonValue(srvTH,"cache.province");void 0===srvTH.cache.province&&(srvTH.cache.province={}),srvTH.cache.province[e]=a},Label=function(e,a){return void 0===a?Label(e,"title"):'<span class="label label-'+a+'">'+e+"</span>"},LabelBg=function(e,a){return'<span class="label" style="background-color:'+a+'">'+e+"</span>"};srvTH.handlerRain=function(e){if(srvTHF.SetRain_Setting(JH.GetJsonValue(e,"setting")),srvTHF.renderModalRainTable(),srvTH.cache.rain_province_date=JH.GetJsonValue(e,"date"),"OK"==JH.GetJsonValue(e,"data.result"))for(var a=JH.GetJsonValue(e,"data.data"),t=0;t<a.length;t++){var r=a[t],n=JH.GetJsonValue(r,"station.tele_station_lat"),o=JH.GetJsonValue(r,"station.tele_station_long"),l=JH.GetJsonValue_Float(r,"rain_24h"),i=JH.GetJsonValue_Float(r,"rain_1h"),s=(srvTHF.Rain_GetColorname(l),JH.GetJsonValue(r,"geocode.warning_zone"));if(""!=s){var c=srvTHF.Rain_GetRuleLevel(s,l,"rain24h"),v=srvTHF.Rain_GetRuleLevel(s,i,"rain1h"),d=Math.max(c,v);if(0!=d&&""!=n&&""!=o){var _=srvTHF.Rain_GetLevelColor(d);if(""==JH.GetJsonValue(_,"colorname"))continue;var u=srvTHF.Rain_Marker([n,o],r,JH.GetJsonValue(_,"colorname"));srvTH.map.addLayer(u)}var T=JH.GetJsonLangValue(r,"geocode.province_name");rain_cacheProvinceLevel(T,d)}}};var control_topleft_icon_rain=function(){var e=rain_head_text(),a=rain_body_text(),t={},r={4:0,3:0},n="",o="",l=rain_cacheProvinceLevel();for(var i in l){var s=l[i];if(!(s<=1)){var c=srvTHF.Rain_GetLevelColor(s);void 0===t[s]&&(t[s]=""),t[s]+=LabelBg(i,c.color),r[s]++,o=r[4]}}return controlBoxRain(e,a,n+=0==o?" ":' <span class="badge badge-danger">'+o+"</span>")},rain_cacheProvinceLevel=function(e,a){if(0==arguments.length)return JH.GetJsonValue(srvTH,"cache.rain_province");void 0===srvTH.cache.rain_province&&(srvTH.cache.rain_province={});var t=Math.max(a,JH.GetJsonValue_Float(srvTH,"cache.rain_province."+e));srvTH.cache.rain_province[e]=t},rain_head_text=function(){return srvTH.TIME},rain_body_text=function(){var e={},a={4:0,3:0},t="",r=rain_cacheProvinceLevel();for(var n in r){var o=r[n];if(!(o<=1)){var l=srvTHF.Rain_GetLevelColor(o);void 0===e[o]&&(e[o]=""),e[o]+=LabelBg(n,l.color),a[o]++}}for(var i in e)t+="<b>"+TRANSLATOR[srvTHF.Rain_GetLevelColor(i).trans]+" : </b>"+e[i]+"<br/>";return""==t&&(t=TRANSLATOR.normal,srvTH.isNormalSituation.rain=!0),t};srvTH.handlerWaterLevel=function(e){if(srvTHF.SetWaterLevel_Setting(JH.GetJsonValue(e,"setting")),srvTHF.renderModalWaterlevelTable(),srvTH.cache.waterlevel_date=JH.GetJsonValue(e,"date"),"OK"==JH.GetJsonValue(e,"data.result"))for(var a=JH.GetJsonValue(e,"data.data"),t=0;t<a.length;t++){var r=a[t],n=JH.GetJsonValue(r,"station"),o=JH.GetJsonValue(n,"tele_station_lat"),l=JH.GetJsonValue(n,"tele_station_long"),i=JH.GetJsonValue(r,"storage_percent"),s=srvTHF.WaterLevel_GetRulelevel(i);if(""!=s){var c=JH.GetJsonLangValue(r,"geocode.province_name");waterlevel_cacheProvinceLevel(c,s);var v=srvTHF.WaterLevel_GetlevelColorName(s);""!=v&&""!=o&&""!=l&&(m=srvTHF.WaterLevel_Marker([o,l],r,v),srvTH.map.addLayer(m))}}};var waterlevel_cacheProvinceLevel=function(e,a){if(0==arguments.length)return JH.GetJsonValue(srvTH,"cache.waterlevel_province");void 0===srvTH.cache.waterlevel_province&&(srvTH.cache.waterlevel_province={});var t=Math.max(a,JH.GetJsonValue_Float(srvTH,"cache.waterlevel_province."+e));srvTH.cache.waterlevel_province[e]=t},control_topleft_icon_waterlevel=function(){var e=waterlevel_head_text(),a=waterlevel_body_text(),t={},r={1:0,2:0},n="",o="",l=waterlevel_cacheProvinceLevel();for(var i in l){var s=l[i],c=srvTHF.WaterLevel_GetlevelColor(s);void 0===t[s]&&(t[s]=""),t[s]+=LabelBg(i,c),r[s]++,o=r[2]}return controlBoxWaterlevel(e,a,n+='<b><span class="badge badge-danger">'+o+"</span></b>")},waterlevel_head_text=function(){return srvTH.TIME},waterlevel_body_text=function(){var e={},a={1:0,2:0},t="",r=waterlevel_cacheProvinceLevel();for(var n in r){var o=r[n],l=srvTHF.WaterLevel_GetlevelColor(o);void 0===e[o]&&(e[o]=""),e[o]+=LabelBg(n,l),a[o]++}for(var i in e)t+="<b>"+TRANSLATOR[srvTHF.GetWaterLevel_Level()[i].trans]+": </b>"+e[i]+"<br/>";return""==t&&(t=TRANSLATOR.normal,srvTH.isNormalSituation.waterlevel=!0),t};srvTH.handlerDam=function(e){srvTHF.SetDam_Scale(e.setting),srvTHF.renderModalDamTable(),srvTH.cache.dam_date=JH.GetJsonValue(e,"date"),"OK"==e.data.result&&(srvTHF.Dam_SortData(e.data.data),srvTH.renderMarkerDam())},srvTH.renderMarkerDam=function(){for(var e=srvTHF.Dam_Low,a=srvTHF.Dam_High,t=0;t<e.length;t++){var r=(i=e[t]).dam,n=JH.GetJsonValue(r,"dam_lat"),o=JH.GetJsonValue(r,"dam_long");if(""!=n||""!=o){var l=JH.GetJsonValue(i,"dam_uses_water_percent");m=srvTHF.Dam_Marker([n,o],i,srvTHF.Dam_GetColorname(l)),m.addTo(srvTH.map)}}for(t=0;t<a.length;t++){var i;r=(i=a[t]).dam,n=JH.GetJsonValue(r,"dam_lat"),o=JH.GetJsonValue(r,"dam_long");if(""!=n||""!=o){l=JH.GetJsonValue(i,"dam_storage_percent");m=srvTHF.Dam_Marker([n,o],i,srvTHF.Dam_GetColorname(l)),m.addTo(srvTH.map)}}};var control_topleft_icon_dam=function(){var e=dam_head_text(),a=dam_body_text(),t="",r=srvTHF.GetDam_High_Text(),n=r.split(",").length;return""!=r&&(t+='<span class="badge badge-danger">'+n+"</span>"),controlBoxDam(e,a,t)},dam_head_text=function(){return""},dam_body_text=function(){var e="",a=srvTHF.GetDam_Low_Text(),t=srvTHF.GetDam_Setting_Low();""!=a&&(e+='<font color="'+t.color+'">'+TRANSLATOR[t.trans]+"</font>"+" : "+a);var r=srvTHF.GetDam_High_Text(),n=(r.split(",").length,srvTHF.GetDam_Setting_High()),o="";return""!=r&&(o='<font color="'+n.color+'">'+TRANSLATOR[n.trans]+"</font>",""!=a&&(e+="<br/>"),e+=o+" : "+r),""==a&&""==r&&(e=TRANSLATOR.normal,srvTH.isNormalSituation.dam=!0),e};srvTH.handlerWaterQuality=function(e){if(srvTHF.SetWaterQuality_Setting(JH.GetJsonValue(e,"setting")),srvTHF.renderModalWaterqualityTable(),srvTH.cache.waterquality_date=JH.GetJsonValue(e,"date"),"OK"==JH.GetJsonValue(e,"data.result"))for(var a=JH.GetJsonValue(e,"data.data"),t=0;t<a.length;t++){var r=a[t],n=JH.GetJsonValue(r,"waterquality_station"),o=JH.GetJsonValue(n,"waterquality_station_lat"),l=JH.GetJsonValue(n,"waterquality_station_long"),i=(JH.GetJsonValue(n,"id"),{waterquality_salinity:JH.GetJsonValue(r,"waterquality_salinity")});if(""!=o&&""!=l){var s=srvTHF.WaterQuality_GetMarkerColor(i);if(s!=srvTHF.GetWaterQuality_Default().color){var c=JH.GetJsonValue_Float(r,"waterquality_salinity");srvTHF.WaterQuality_GetColor_salinity(c)!=srvTHF.GetWaterQuality_Default().color&&waterquality_cache(r,"salinity"),m=srvTHF.WaterQuality_Marker([o,l],r,s),srvTH.map.addLayer(m)}}}};var control_topleft_icon_waterquality=function(){var e=waterquality_head_text(),a=waterquality_body_text(),t="",r=waterquality_cache(),n="";for(var o in r)n=r[o];return n.length>0&&(t+='<span class="badge badge-danger">'+n.length+"</span>"),controlBoxWaterquality(e,a,t)},waterquality_cache=function(e,a){if(0==arguments.length)return JH.GetJsonValue(srvTH,"cache.waterquality");void 0===srvTH.cache.waterquality&&(srvTH.cache.waterquality={}),void 0===srvTH.cache.waterquality[a]&&(srvTH.cache.waterquality[a]=[]),srvTH.cache.waterquality[a].push(e)},waterquality_head_text=function(){return srvTH.TIME},waterquality_body_text=function(){srvTHF.GetWaterQuality_Display();var e="",a=waterquality_cache();for(var t in a){var r=a[t];""!=e&&(e+="<br/>"),e+="<b>"+JH.GetJsonValue(TRANSLATOR,"waterquality_alert_"+t)+"</b> ";for(var n=0;n<r.length;n++){var o=r[n],l=JH.GetJsonLangValue(o,"waterquality_station.waterquality_station_name"),i=JH.GetJsonValue_Float(o,"waterquality_"+t),s=srvTHF.WaterQuality_GetColor(JH.GetJsonValue(srvTHF.GetWaterQuality_Scale(),t),i);e+=LabelBg(l,s)}}return""==e&&(e=TRANSLATOR.normal,srvTH.isNormalSituation.waterquality=!0),e};srvTH.handlerStorm=function(e){if(srvTHF.SetStorm_Setting(JH.GetJsonValue(e,"setting")),srvTHF.renderModalStormTable(),srvTH.cache.storm_date=JH.GetJsonValue(e,"date"),"OK"!=JH.GetJsonValue(e,"data.result"))return!1;for(var a=JH.GetJsonValue(e,"data.data"),t=[],r="",n="",o="",l=4,i=!0,s=moment.utc(srvTH.cache.storm_date),c=0;c<a.length;c++){""!=r&&i&&storm_cache(""==n?{name:r,color:o}:{name:r,color:n}),t=[];var v=a[c];r=JH.GetJsonLangValue(v,"storm_name"),l=4,i=!0,n="";for(var d=JH.GetJsonValue(v,"storm_data"),_=0;_<d.length;_++){var u=d[_],T=JH.GetJsonValue(u,"storm_lat"),H=JH.GetJsonValue(u,"storm_long"),h=JH.GetJsonValue(u,"storm_wind"),f=moment(JH.GetJsonValue(u,"storm_datetime")),J=h.split(" ");""!=T&&""!=H&&""!=J[0]&&(o=srvTHF.Storm_GetColor(J[0]),t.push([T,H]),t.length<2||(t.length>2&&t.splice(0,1),L.polyline(t,{color:o,weight:l}).addTo(srvTH.map),f.isAfter(s)&&(i&&2==t.length&&(n=o,L.circleMarker(t[t.length-1],{color:n,weight:l+2}).setRadius(5).addTo(srvTH.map),i=!1,storm_cache({name:r,color:o})),l=2)))}}""!=r&&i&&storm_cache(""==n?{name:r,color:o}:{name:r,color:n})};var control_topleft_icon_storm=function(){var e=storm_headText(),a=storm_bodyText(),t=storm_cache(),r="";return console.log(t),t.length>0&&(r+='<span class="badge badge-danger">'+t.length+"</span>"),controlBoxStorm(e,a,r)},storm_cache=function(e){if(0==arguments.length)return JH.GetJsonValue(srvTH,"cache.storm");void 0===srvTH.cache.storm&&(srvTH.cache.storm=[]),srvTH.cache.storm.push(e)},storm_headText=function(){return""},storm_bodyText=function(){var e="",a=storm_cache();0==a.length&&(e=TRANSLATOR.no_storm,srvTH.isNormalSituation.storm=!0);for(var t=0;t<a.length;t++){var r=a[t];e+=LabelBg(JH.GetJsonValue(r,"name"),JH.GetJsonValue(r,"color"))}return e};srvTH.handlerPreRain=function(e){var a=JH.GetJsonValue(e,"setting");srvTHF.SetPreRain_Setting(a),srvTHF.renderModalClockTable();var t={};if("OK"!=JH.GetJsonValue(e,"data.result"))return!1;for(var r=JH.GetJsonValue(e,"data.data"),n=0;n<r.length;n++){var o=r[n],l=JH.GetJsonLangValue(o,"province_name",!0),i=JH.GetJsonValue(o,"rainforecast_level");""==JH.GetJsonValue(t,i)&&(t[i]=[]),t[i].push(l)}var s=srvTHF.GetPreRain_LevelText();for(var c in t)if(""!=c){var v=t[c],d=JH.GetJsonValue(s,c+".color");for(n=0;n<v.length;n++)srvTH.FEATURE_PROVINCE.province[v[n]].setStyle({fillColor:d}),prerain_cache(v[n],d,c)}};var prerain_cache=function(e,a,t){if(0==arguments.length)return JH.GetJsonValue(srvTH,"cache.prerain");void 0===srvTH.cache.prerain&&(srvTH.cache.prerain={},srvTH.cache.prerain_province=[]),void 0===srvTH.cache.prerain[t]&&(srvTH.cache.prerain[t]=""),srvTH.cache.prerain_province.push(e),srvTH.cache.prerain[t]+=LabelBg(e,a)},control_topleft_icon_clock=function(){var e=prerain_headText(),a=prerain_bodyText();prerain_cache(),srvTHF.GetPreRain_LevelText();return controlBoxPredictRain(e,a,"")},prerain_headText=function(){return""},prerain_bodyText=function(){var e="",a=prerain_cache(),t=srvTHF.GetPreRain_LevelText(),r=0;if(a)for(var n in a){0!=r&&(e+="<br/>");var o=a[n];e+="<b>"+TRANSLATOR[JH.GetJsonValue(t,n+".trans")]+"</b> : "+o,r++}else e=TRANSLATOR.normal,srvTH.isNormalSituation.prerain=!0;return e};srvTH.handlerWave=function(e){var a=JH.GetJsonValue(e,"setting");if(Array.isArray(a)&&(a=a[0]),srvTHF.SetWave_Setting(a),srvTHF.renderModalWaveTable(),srvTH.cache.wave_date=JH.GetJsonValue(e,"date"),"OK"==JH.GetJsonValue(e,"data.result"))for(var t=JH.GetJsonValue(e,"data.data"),r=0;r<t.length;r++){var n=t[r],o=JH.GetJsonValue(n,"swan_station"),l=JH.GetJsonValue(o,"lat"),i=JH.GetJsonValue(o,"long"),s=JH.GetJsonValue_Float(o,"province_code");JH.GetJsonLangValue(o,"province_name");if(wave_cache(s),""!=l&&""!=i){var c=JH.GetJsonValue(a,"colorname"),v=srvTHF.Wave_Marker([l,i],n,c);srvTH.map.addLayer(v)}}};var control_topleft_icon_wave=function(e){var a=wave_headText(),t=wave_bodyText(),r="";if(wave_cache()){var n=$.unique(wave_cache()).sort(function(e,a){return e-a});console.log(n),n.length&&(r+='<span class="badge badge-danger">'+n.length+"</span>")}return controlBoxPredictWave(a,t,r)},wave_cache=function(e){if(0==arguments.length)return JH.GetJsonValue(srvTH,"cache.wave");void 0===srvTH.cache.wave&&(srvTH.cache.wave=[]),srvTH.cache.wave.push(parseInt(e))},wave_headText=function(){return srvTH.TIME},wave_bodyText=function(){var e="",a=srvTHF.GetWave_Setting(),t=province_cache();if(!wave_cache())return srvTH.isNormalSituation.wave=!0,TRANSLATOR.normal;for(var r=$.unique(wave_cache()).sort(function(e,a){return e-a}),n=0;n<r.length;n++){var o=r[n];e+=LabelBg(JH.GetJsonLangValue(t,o+".province_name"),JH.GetJsonValue(a,"color"))}return""!=e&&(e=TRANSLATOR.wave_body_head_text+" ("+r.length+")<br/>"+e),e};srvTH.handlerWarning=function(e){var a=JH.GetJsonValue(e,"setting"),t=JH.GetJsonValue(e,"drought");"OK"==JH.GetJsonValue(t,"result")&&((r=JH.GetJsonValue(t,"data")).length>0&&(srvTH.cache.warning_drought=r));var r,n=JH.GetJsonValue(e,"flood");"OK"==JH.GetJsonValue(n,"result")&&((r=JH.GetJsonValue(n,"data")).length>0&&(srvTH.cache.warning_flood=r));srvTHF.SetWarning_Setting(a)};var control_topleft_icon_warnning=function(){var e=warning_headText(),a=warning_bodyText(),t=srvTHF.GetWarning_Setting(),r=(JH.GetJsonValue(t,"rain"),JH.GetJsonValue(t,"drought"),JH.GetJsonValue(t,"flood"),rain_cacheProvinceLevel(),JH.GetJsonValue(srvTH.cache,"prerain_province"),JH.GetJsonValue(srvTH.cache,"warning_drought")),n=JH.GetJsonValue(srvTH.cache,"warning_flood"),o="",l=0;return r.length>0&&(l+=r.length),n.length>0&&(l+=n.length),l>0&&(o+='<span class="badge badge-danger">'+l+"</span>"),a=warning_provinceHandler(),controlBoxRisk(e,a,o)},warning_provinceHandler=function(){var e=self._HOST_+"/proxy.php?url=http%3A%2F%2Fportal.disaster.go.th%2Fportal%2Fwsxml%3FqueryCode%3DDPM010%26user%3Dxws-0010%26password%3Dxws0010";return $.ajax({type:"GET",crossDomain:!0,url:e,dataType:"json",success:warning_provinceXmlParser,error:function(e){console.log("Connection to disaster.go.th fail")}}),"ปกติ"},warning_provinceXmlParser=function(e){var a=[];return $(e.contents).find("row").each(function(){var e=$(this).find("PROVINCE_ID").text(),t=$(this).find("PROVINCE_NAME").text();"เกิดเหตุการณ์"==$(this).find("STATUS_NAME").text()&&(a[e]=t)}),a=a.filter(function(){return!0}),warning_provinceShowLabel(a)},warning_provinceShowLabel=function(e){var a="";e.length>0?$.each(e,function(e,t){a+='<span class="label" style="background-color:#FF0000">'+t+"</span>"}):a+="ปกติ",$(".control-box-warning").find(".control-body").html(a)},warning_headText=function(){return""},warning_bodyText=function(){var e=srvTHF.GetWarning_Setting(),a=(JH.GetJsonValue(e,"rain"),JH.GetJsonValue(e,"drought")),t=(JH.GetJsonValue(e,"flood"),""),r=(rain_cacheProvinceLevel(),JH.GetJsonValue(srvTH.cache,"warning_drought")),n=JH.GetJsonValue(srvTH.cache,"warning_flood");if(!r&&!n)return srvTH.isNormalSituation.warning=!0,"-";if(r){t+="<br/>"+TRANSLATOR.risk_text_drought+TRANSLATOR.ambit+TRANSLATOR.province;for(var o=0;o<r.length;o++){var l=r[o],i=JH.GetJsonLangValue(l,"province_name"),s=JH.GetJsonLangValue(l,"province_code");t+=LabelBg(i,a),(c=JH.GetJsonLangValue(srvTH.FEATURE_PROVINCE.province,s))&&c.setStyle({color:a,weight:2,opacity:1})}}else t+="<br/>"+TRANSLATOR.no_risk+TRANSLATOR.risk_text_drought;if(n){t+="<br/>"+TRANSLATOR.risk_text_warning+TRANSLATOR.ambit+TRANSLATOR.province;for(o=0;o<n.length;o++){var c;l=n[o],i=JH.GetJsonLangValue(l,"province_name"),s=JH.GetJsonLangValue(l,"province_code");t+=LabelBg(i,a),(c=JH.GetJsonLangValue(srvTH.FEATURE_PROVINCE.province,s))&&c.setStyle({color:a,weight:2,opacity:1})}}else t+="<br/>"+TRANSLATOR.no_risk+TRANSLATOR.risk_text_warning;return t},control_topleft_icon_flood=function(){var e=flood_headText();return flood_bodyText(),controlBoxFloodWarning(e,"","")},flood_headText=function(){return""},UrlExists=function(e){var a=new XMLHttpRequest;return a.open("HEAD",e,!1),a.send(),"404"!=a.status},flood_bodyText=function(){var e=self._HOST_+"/dowload_datas_warning",a=self._HOST_+"/datas/dwr_data_lastest.xlsx";if($.ajax({type:"GET",crossDomain:!0,url:e,error:function(e){console.log("Connection datas/dwr_data_lastest.xlsx fail")}}),1!=UrlExists(a))return"ปกติ";var t=new XMLHttpRequest;t.open("GET",a,!0),t.responseType="arraybuffer";t.onload=function(e){for(var a=t.response,r=new Uint8Array(a),n=new Array,o=0;o!=r.length;++o)n[o]=String.fromCharCode(r[o]);var l=n.join(""),i=XLSX.read(l,{type:"binary"}),s=i.SheetNames[0],c=i.Sheets[s],v=XLSX.utils.sheet_to_json(c,{raw:!0}),d=[],_=[],u="",T="",H=["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."],h=moment((new Date).toLocaleString("en-US",{timeZone:"Asia/Bangkok"})).format("YYYY-MM-DD");for(o=1;o<=v.length-1;o++)if(void 0!==v[o].__EMPTY_8){var f=v[o].__EMPTY_8.split(" "),J=H.indexOf(f[1])+1;if(J>=0&&J<=11){1==(J+="").length&&(J="0"+J);var m=moment(new Date("2018-"+J+"-"+f[0]).toLocaleString("en-US",{timeZone:"Asia/Bangkok"})).format("YYYY-MM-DD");if(moment.duration(moment(h).diff(moment(m))).asDays()<=1&&void 0!==v[o].__EMPTY_7){void 0===v[o].__EMPTY_1&&(v[o].__EMPTY_1=v[o-1].__EMPTY_1),void 0===v[o].__EMPTY_4&&(v[o].__EMPTY_4=v[o-1].__EMPTY_4);var p=v[o].__EMPTY_7,g=v[o].__EMPTY_1,G=v[o].__EMPTY_4;p.search("สีแดง")>0&&(_.push({status:"เตือนภัยสีแดง",status:p,station:g,province:G}),u+='<span class="label" style="background-color:#EE141F">'+g+" จ."+G+"</span>"),p.search("สีเหลือง")>0&&(d.push({status:"เตือนภัยสีเหลือง",status:p,station:g,province:G}),T+='<span class="label" style="background-color:#FFA500">'+g+" จ."+G+"</span>")}}}_.length>0||d.length>0?(t.datas="<div><b>เตือนภัยสีแดง : </b> "+u+"<br><b>เตือนภัยสีเหลือง : </b> "+T+"</div>",$(".control-box-flood-warning").find(".control-body").html(t.datas)):$(".control-box-flood-warning").find(".control-body").html("ปกติ"),_.length>0&&$(".control-box-flood-warning").find(".icon").html('<span class="badge badge-danger">'+_.length+"</span>");var w=$(".control-box-flood-warning"),L=w.find(".control-body"),A=L.find("div"),b=L.height();A.height()>b&&w.find(".control-arrow").addClass("hasDown")},t.send()},controlBox=function(e,a,t,r,n,o){var l=document.createElement("div");l.className="row";var i=document.createElement("div");i.className="col-md-7 "+e;var s=document.createElement("div");s.className="control-box control-box-"+a;var c=document.createElement("div");c.className="control-head";var v=document.createElement("div");v.className="icon",v.innerHTML=o,v.addEventListener("click",function(){var e=$(this).closest("div.row");if(srvTH.currentRow&&(srvTH.currentRow.removeClass("active"),e.index()==srvTH.currentRow.index()))return srvTH.currentRow=null,!1;e.addClass("active"),srvTH.currentRow=e});var d=document.createElement("div");d.className="info",d.addEventListener("click",function(){$("#modal-"+a).modal()});var _=document.createElement("div");_.className="control-head-text",_.innerHTML=t+"<span>"+r+"</span>",c.appendChild(v),c.appendChild(d),c.appendChild(_);var u=document.createElement("div");u.className="control-body",u.innerHTML="<div>"+n+"</div>";var T=document.createElement("div");return T.className="control-arrow",T.innerHTML='<span class="fa fa-angle-down"></span><span class="fa fa-angle-up"></span>',s.appendChild(c),s.appendChild(u),s.appendChild(T),i.appendChild(s),l.appendChild(i),l},genTagA=function(e,a){return s="<a ",a&&(s+='href="'+a+'" '),s+="> "+e+"</a>",s},controlBoxRain=function(e,a,t){return controlBox("col-md-offset-2","rain",genTagA(JH.GetJsonValue(TRANSLATOR,"rain"),srvTH._MAIN_PAGE_+"#box-rain"),e,a,t)},controlBoxWaterlevel=function(e,a,t){return controlBox("col-md-offset-1","waterlevel",genTagA(JH.GetJsonValue(TRANSLATOR,"waterlevel"),srvTH._MAIN_PAGE_+"#box-waterlevel"),e,a,t)},controlBoxDam=function(e,a,t){return controlBox("col-md-offset-1","dam",genTagA(JH.GetJsonValue(TRANSLATOR,"dam"),srvTH._MAIN_PAGE_+"#box-dam"),e,a,t)},controlBoxWaterquality=function(e,a,t){return controlBox("col-md-offset-2","waterquality",genTagA(JH.GetJsonValue(TRANSLATOR,"waterquality"),srvTH._MAIN_PAGE_+"#box-waterquality"),e,a,t)},controlBoxStorm=function(e,a,t){return controlBox("col-md-offset-3","storm",genTagA(JH.GetJsonValue(TRANSLATOR,"storm"),srvTH._MAIN_PAGE_+"#box-storm"),e,a,t)},controlBoxPredictRain=function(e,a,t){return controlBox("col-md-offset-4","clock",genTagA(JH.GetJsonValue(TRANSLATOR,"predict_rain"),srvTH._MAIN_PAGE_+"#box-predict_rain"),e,a,t)},controlBoxPredictWave=function(e,a,t){return controlBox("col-md-offset-4","wave",genTagA(JH.GetJsonValue(TRANSLATOR,"predict_wave"),srvTH._MAIN_PAGE_+"#box-predict_wave"),e,a,t)},controlBoxRisk=function(e,a,t){return controlBox("col-md-offset-3","warning",genTagA(JH.GetJsonValue(TRANSLATOR,"risk"),srvTH._MAIN_PAGE_+"#box-risk"),e,a,t)},controlBoxFlood=function(e,a,t){return controlBox("col-md-offset-3","flood",genTagA(JH.GetJsonValue(TRANSLATOR,"flood_forecast"),srvTH._MAIN_PAGE_+"#box-flood"),e,a,t)},controlBoxFloodWarning=function(e,a,t){return controlBox("col-md-offset-3","flood-warning",genTagA(JH.GetJsonValue(TRANSLATOR,"flood_warning"),srvTH._MAIN_PAGE_+"#box-flood"),e,a,t)},arrowDownClick=function(e){var a=$(e).closest(".control-arrow"),t=$(e).closest(".control-box").find(".control-body"),r=t.find("div"),n=t.height(),o=r.height()-n,l=parseInt(r.css("top"),10),i=parseInt(r.css("font-size"),10);o+(l-=i)+i>=0?a.addClass("hasUp"):(a.removeClass("hasDown"),clearInterval(srvTH.cache.interval),srvTH.cache.interval&&(srvTH.cache.interval=null)),r.css("top",l+"px")},arrowUpClick=function(e){var a=$(e).closest(".control-arrow"),t=$(e).closest(".control-box").find(".control-body"),r=t.find("div"),n=t.height(),o=(r.height(),parseInt(r.css("top"),10));(o+=parseInt(r.css("font-size"),10))<0?a.addClass("hasDown"):(a.removeClass("hasUp"),clearInterval(srvTH.cache.interval),srvTH.cache.interval&&(srvTH.cache.interval=null),o=0),r.css("top",o+"px")};